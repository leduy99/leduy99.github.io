<!DOCTYPE html>
<html lang="en">
  <head>
    <!--
      Complete Portfolio v5 (with MapMyVisitors)
      - Lightweight canvas trailSpark (full-page)
      - Sticky sidebar, aurora + subtle blobs, glass cards, timeline
      - Fast loader, magnetic buttons, scroll progress bar
      - Type loop + flickering underscore cursor
      - Visitors section with MapMyVisitors + total visits badge
    -->

    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Duy Le — Portfolio</title>

    <!-- Tailwind CSS (CDN) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>tailwind.config = { darkMode: 'class' };</script>

    <!-- Apply saved theme ASAP to avoid FOUC -->
    <script>
      (function () {
        try {
          const t = localStorage.getItem('theme');
          if (t === 'light') document.documentElement.classList.remove('dark');
          else document.documentElement.classList.add('dark');
        } catch (e) {}
      })();
    </script>

    <!-- Inter variable font -->
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Inter:slnt,wght@-10..0,100..900&display=swap" rel="stylesheet" />

    <!-- AOS (optional) -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/aos@2.3.4/dist/aos.css" />

    <style>
      html {
        font-family: Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
        transition: background-color 0.35s ease, color 0.35s ease;
      }

      /* Aurora background layer (calm), behind everything */
      .aurora {
        position: fixed; inset: 0; z-index: -3; pointer-events: none;
        background:
          radial-gradient(1200px 600px at 10% 10%, rgba(59,130,246,.15), transparent 60%),
          radial-gradient(1000px 500px at 90% 20%, rgba(45,212,191,.12), transparent 60%),
          radial-gradient(900px 600px at 50% 100%, rgba(99,102,241,.18), transparent 60%);
        filter: blur(30px);
      }
      .dark .aurora {
        background:
          radial-gradient(1200px 600px at 10% 10%, rgba(59,130,246,.18), transparent 60%),
          radial-gradient(1000px 500px at 90% 20%, rgba(45,212,191,.16), transparent 60%),
          radial-gradient(900px 600px at 50% 100%, rgba(99,102,241,.22), transparent 60%);
      }

      /* Floating blobs (subtle) */
      .blobs { position: fixed; inset: 0; z-index: -2; pointer-events: none; overflow: hidden; }
      .blob {
        position: absolute; width: 32vmax; height: 32vmax; border-radius: 50%;
        filter: blur(40px); opacity: .12; will-change: transform;
        animation: drift 38s ease-in-out infinite;
      }
      .blob:nth-child(1){ left:-10vmax; top:5vmax; background: #60a5fa; animation-delay: 0s;}
      .blob:nth-child(2){ right:-12vmax; top:-8vmax; background: #22d3ee; animation-delay: 6s;}
      .blob:nth-child(3){ left:20%; bottom:-12vmax; background: #818cf8; animation-delay: 12s;}
      @keyframes drift {
        0%   { transform: translate3d(0,0,0) scale(1); }
        50%  { transform: translate3d(4vmax,-3vmax,0) scale(1.08); }
        100% { transform: translate3d(0,0,0) scale(1); }
      }
      .dark .blob { opacity: .16; }

      /* Reduced motion */
      @media (prefers-reduced-motion: reduce) {
        .aurora { filter: blur(24px); }
        .blob { animation: none !important; }
      }

      /* Canvas FX layer: above content, below loader/progress */
      #fxCanvas {
        position: fixed; inset: 0;
        z-index: 58; /* loader 70, progress 60, nav 50, content default */
        pointer-events: none;
      }

      /* Glass card helper */
      .glass {
        background: rgba(255,255,255,.6);
        backdrop-filter: blur(12px);
        -webkit-backdrop-filter: blur(12px);
        border: 1px solid rgba(255,255,255,.2);
      }
      .dark .glass {
        background: rgba(2,6,23,.6);
        border-color: rgba(255,255,255,.08);
      }

      .brand-gradient {
        background: linear-gradient(90deg, #06b6d4, #3b82f6);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
      }
      .dark .brand-gradient {
        background: linear-gradient(90deg, #2dd4bf, #2563eb);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
      }

      .timeline-dot {
        position: absolute; left: -0.4rem; top: 1.4rem;
        width: .75rem; height: .75rem; border-radius: 9999px;
        background: #06b6d4;
        box-shadow: 0 0 0 6px rgba(255,255,255,.6);
      }
      .dark .timeline-dot { box-shadow: 0 0 0 6px rgba(2,6,23,.6); }

      /* Typed heading styling */
      #typed-about-me {
        font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
        font-weight: 700; color: #2563eb;
      }
      .dark #typed-about-me { color: #2dd4bf; }

      /* Blinking underscore cursor */
      #typed-cursor {
        display: inline-block; width: 0.6ch; margin-left: 2px;
        animation: cursorBlink .9s steps(2, start) infinite;
      }
      @keyframes cursorBlink { 0%,49%{opacity:1} 50%,100%{opacity:0} }
      @media (prefers-reduced-motion: reduce) { #typed-cursor { animation: none; opacity: 1; } }

      .hover-tilt { transition: transform .25s ease; }
      .hover-tilt:hover { transform: rotate(.4deg) translateY(-2px); }

      /* Scroll progress bar */
      #scrollProgress {
        position: fixed; top: 0; left: 0; height: 3px; width: 0%;
        z-index: 60;
        background: linear-gradient(90deg, #22d3ee, #3b82f6);
        box-shadow: 0 0 12px rgba(59,130,246,.6);
        transform-origin: left center;
      }
      .dark #scrollProgress { box-shadow: 0 0 12px rgba(45,212,191,.6); }

      /* MapMyVisitors sizing */
      #mmvWrap {
        width: 100%;
        max-width: 680px;   /* control max width */
        height: 360px;      /* control height */
        margin: 0 auto;     /* center */
        overflow: hidden;
        border-radius: 0.75rem;
      }
      @media (max-width: 640px){
        #mmvWrap { height: 300px; }
      }
      /* force widget to fill wrapper */
      #mmvWrap > *, #mmvMount > * {
        width: 100% !important;
        height: 100% !important;
        max-width: 100% !important;
      }
    </style>
  </head>

  <body class="min-h-screen bg-slate-50 text-slate-800 dark:bg-slate-950 dark:text-slate-300">
    <!-- Loader Overlay -->
    <div id="loader" class="fixed inset-0 z-[70] grid place-items-center bg-white/90 dark:bg-slate-950/90 backdrop-blur">
      <div class="relative w-28 h-28">
        <div class="absolute inset-0 animate-[spin_2.2s_linear_infinite]">
          <div class="absolute left-1/2 top-0 -translate-x-1/2 w-3 h-3 rounded-full bg-gradient-to-b from-cyan-400 to-blue-600"></div>
          <div class="absolute left-0 top-1/2 -translate-y-1/2 w-3 h-3 rounded-full bg-gradient-to-b from-violet-400 to-cyan-400"></div>
          <div class="absolute right-0 top-1/2 -translate-y-1/2 w-3 h-3 rounded-full bg-gradient-to-b from-blue-400 to-violet-500"></div>
          <div class="absolute left-1/2 bottom-0 -translate-x-1/2 w-3 h-3 rounded-full bg-gradient-to-b from-teal-400 to-blue-500"></div>
        </div>
        <div class="absolute inset-0 grid place-items-center">
          <div class="px-4 py-2 rounded-xl bg-white/70 dark:bg-slate-900/70 border border-white/30 dark:border-white/10 backdrop-blur text-slate-800 dark:text-slate-200 text-sm font-medium">
            Loading Duy Le…
          </div>
        </div>
      </div>
    </div>

    <!-- Scroll progress bar -->
    <div id="scrollProgress" aria-hidden="true"></div>

    <!-- Background layers -->
    <div class="aurora" aria-hidden="true"></div>
    <div class="blobs" aria-hidden="true">
      <div class="blob"></div><div class="blob"></div><div class="blob"></div>
    </div>

    <!-- Full-page canvas FX -->
    <canvas id="fxCanvas" aria-hidden="true"></canvas>

    <!-- Top navigation -->
    <nav class="sticky top-0 z-50 backdrop-blur border-b border-slate-200/70 dark:border-slate-800/80 bg-white/70 dark:bg-slate-900/60">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 h-16 flex items-center justify-between">
        <a href="#" class="text-lg md:text-xl font-semibold brand-gradient" aria-label="Home">Le Dinh Anh Duy</a>
        <ul class="hidden md:flex items-center gap-6 text-sm">
          <li><a class="hover:text-blue-600 dark:hover:text-teal-400" href="#about">About</a></li>
          <li><a class="hover:text-blue-600 dark:hover:text-teal-400" href="#news">News</a></li>
          <li><a class="hover:text-blue-600 dark:hover:text-teal-400" href="#publications">Publications</a></li>
          <li><a class="hover:text-blue-600 dark:hover:text-teal-400" href="#careers">Education & Careers</a></li>
        </ul>
        <button
          id="toggleThemeBtn"
          type="button"
          aria-pressed="false"
          class="magnet ml-4 inline-flex items-center gap-2 rounded-xl border border-slate-300/70 dark:border-slate-700/70 px-3 py-1.5 text-sm
                 bg-white/70 dark:bg-slate-900/60 hover:bg-white/90 dark:hover:bg-slate-900/80
                 text-slate-700 dark:text-slate-200"
        >
          <span aria-hidden="true">🌓</span>
          <span class="sr-only">Toggle dark mode</span>
          <span id="themeLabel">Theme</span>
        </button>
      </div>
    </nav>

    <!-- Hero -->
    <header class="relative isolate max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 pt-6 md:pt-8 pb-4">
      <h1 class="text-2xl md:text-4xl font-semibold tracking-tight text-slate-900 dark:text-slate-100">Portfolio</h1>
      <p class="mt-1 text-slate-600 dark:text-slate-300">Computer Vision • Research • Engineering</p>
    </header>

    <!-- Main layout -->
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 pb-12">
      <div class="flex flex-col md:flex-row md:items-start md:gap-6">
        <!-- Sidebar -->
        <aside class="md:w-1/3 lg:w-1/4 w-full md:sticky md:top-24 h-fit md:self-start mb-6 md:mb-0">
          <section class="glass rounded-2xl shadow-sm p-6 hover-tilt" data-aos="fade-right">
            <div class="w-28 h-28 mx-auto mb-3">
              <img src="media/avatar.jpg" alt="Portrait of Duy Le" width="160" height="160" loading="lazy"
                   class="rounded-full w-full h-full object-cover ring-2 ring-white/50 dark:ring-black/30 shadow-lg" />
            </div>
            <div class="text-center">
              <h2 class="text-xl font-bold text-slate-800 dark:text-slate-100">Le Dinh Anh Duy</h2>
              <p class="text-slate-600 dark:text-slate-300 text-sm">PhD Student @ MBZUAI</p>
              <p class="mt-3 text-xs text-slate-700/90 dark:text-slate-200/90">
                Trying to bridge the gap between AI power and human imagination.
              </p>
            </div>

            <ul class="mt-4 space-y-2 text-sm text-slate-700 dark:text-slate-200">
              <li class="flex items-center gap-2"><span class="w-5">📍</span> Masdar City, Abu Dhabi, UAE</li>
              <li class="flex items-center gap-2">
                <span class="w-5">✉️</span>
                <a href="mailto:leduy99.work@gmail.com" class="text-blue-700 dark:text-teal-400 hover:underline">leduy99.work@gmail.com</a>
              </li>
              <li class="flex items-center gap-2">
                <span class="w-5">💻</span>
                <a href="https://github.com/leduy99" target="_blank" class="text-blue-700 dark:text-teal-400 hover:underline">GitHub</a>
              </li>
              <li class="flex items-center gap-2">
                <span class="w-5">🎓</span>
                <a href="https://scholar.google.com/citations?user=D2CivSMAAAAJ&hl=en" target="_blank" class="text-blue-700 dark:text-teal-400 hover:underline">Google Scholar</a>
              </li>
            </ul>

            <div class="mt-5 flex flex-wrap gap-2">
              <a href="#publications" class="magnet px-3 py-1.5 rounded-lg border border-slate-300/60 dark:border-slate-700/60 bg-white/60 dark:bg-slate-900/60 backdrop-blur hover:bg-white/80 dark:hover:bg-slate-900/80 text-xs shadow-sm">Publications</a>
              <a href="#news" class="magnet px-3 py-1.5 rounded-lg border border-slate-300/60 dark:border-slate-700/60 bg-white/60 dark:bg-slate-900/60 backdrop-blur hover:bg-white/80 dark:hover:bg-slate-900/80 text-xs shadow-sm">News</a>
              <a href="#careers" class="magnet px-3 py-1.5 rounded-lg border border-slate-300/60 dark:border-slate-700/60 bg-white/60 dark:bg-slate-900/60 backdrop-blur hover:bg-white/80 dark:hover:bg-slate-900/80 text-xs shadow-sm">Education</a>
            </div>
          </section>
        </aside>

        <!-- Main Column -->
        <main class="md:w-2/3 lg:w-3/4 w-full space-y-6" data-aos="fade-up">
          <!-- About -->
          <section id="about" class="glass rounded-2xl shadow-sm p-6 hover-tilt scroll-mt-24">
            <h2 id="typed-about-me" class="text-xl">
              <span id="typed-about-me-text"></span><span id="typed-cursor">_</span>
            </h2>
            <p class="mt-3 text-sm leading-relaxed text-slate-700 dark:text-slate-200">
              I'm a PhD student at MBZUAI, focusing on
              computer vision. From my early days tinkering with computers, I've been passionate about how
              technology can transform human ideas into reality—particularly in creating visuals that help
              share stories, dreams, and experiences. In my free time, I love traveling, gaming, indulging
              in good food, watching anime, and diving into philosophical discussions.
            </p>
          </section>

          <!-- News -->
          <section id="news" class="glass rounded-2xl shadow-sm p-6 hover-tilt scroll-mt-24">
            <h3 class="text-xl font-bold mb-3 text-slate-900 dark:text-slate-100">Latest News</h3>
            <ul class="list-disc list-inside space-y-2 text-sm text-slate-700 dark:text-slate-200">
              <li><span class="font-medium">2024.10:</span> 🎉 Received grant funding for travel trip to ECAI and ACCV.</li>
              <li><span class="font-medium">2024.09:</span> 🎉 Received <b>Reginald R. ‘Barney’ &amp; Jameson A. Baxter Graduate Fellowship</b>.</li>
            </ul>
          </section>

          <!-- Publications -->
          <section id="publications" class="glass rounded-2xl shadow-sm p-6 hover-tilt scroll-mt-24">
            <h3 class="text-xl font-bold mb-4 text-slate-900 dark:text-slate-100">Publications</h3>
            <ol class="relative border-s border-slate-200 dark:border-slate-700">
              <li class="relative pl-6 py-4">
                <span class="timeline-dot"></span>
                <a href="https://uark-aicv.github.io/G2MOT/" target="_blank" rel="noopener" class="font-semibold hover:underline text-slate-800 dark:text-slate-100">
                  Enhanced Kalman with Adaptive Appearance Motion SORT for Grounded Generic Multiple Object Tracking
                </a>
                <div class="mt-1 text-sm text-slate-600 dark:text-slate-300">
                  <b>Duy Le Dinh Anh</b>, Kim Hoang Tran, Quang-Thuc Nguyen, Ngan Hoang Le — <em>ACCV 2024 (oral)</em>
                </div>
              </li>
              <li class="relative pl-6 py-4">
                <span class="timeline-dot"></span>
                <a href="https://fsoft-aic.github.io/TP-GMOT/" target="_blank" rel="noopener" class="font-semibold hover:underline text-slate-800 dark:text-slate-100">
                  TP-GMOT: Tracking Generic Multiple Object by Textual Prompt with Motion-Appearance Cost (MAC) SORT
                </a>
                <div class="mt-1 text-sm text-slate-600 dark:text-slate-300">
                  <b>Duy Le Dinh Anh</b>, Kim Hoang Tran, Ngan Hoang Le — <em>ECAI 2024 (oral)</em>
                </div>
              </li>
              <li class="relative pl-6 py-4">
                <span class="timeline-dot"></span>
                <a href="https://arxiv.org/abs/2311.00729" target="_blank" rel="noopener" class="font-semibold hover:underline text-slate-800 dark:text-slate-100">
                  ZEETAD: Adapting Pretrained Vision-Language Model for Zero-Shot End-to-End Temporal Action Detection
                </a>
                <div class="mt-1 text-sm text-slate-600 dark:text-slate-300">
                  Thinh Phan, Khoa Vo, <b>Duy Le</b>, Gianfranco Doretto, Donald Adjeroh, Ngan Le — <em>WACV 2024</em>
                </div>
              </li>
              <li class="relative pl-6 py-4">
                <span class="timeline-dot"></span>
                <a href="https://fsoft-aic.github.io/Z-GMOT/" target="_blank" rel="noopener" class="font-semibold hover:underline text-slate-800 dark:text-slate-100">
                  Z-GMOT: Zero-shot Generic Multiple Object Tracking
                </a>
                <div class="mt-1 text-sm text-slate-600 dark:text-slate-300">
                  Kim Hoang Tran, <b>Anh Duy Le Dinh</b>, Tien Phat Nguyen, Thinh Phan, Pha Nguyen, Khoa Luu, Donald Adjeroh, Gianfranco Doretto, Ngan Hoang Le — <em>NAACL Findings 2024</em>
                </div>
              </li>
              <li class="relative pl-6 py-4">
                <span class="timeline-dot"></span>
                <a href="https://ieeexplore.ieee.org/abstract/document/10288740" target="_blank" rel="noopener" class="font-semibold hover:underline text-slate-800 dark:text-slate-100">
                  AANet: Motorcycle ReID Using Multi-Atrous Convolution and Self-Attention Mechanisms
                </a>
                <div class="mt-1 text-sm text-slate-600 dark:text-slate-300">
                  Trong-Hieu Nguyen-Mau, Kim-Trang Phu-Thi, <b>Anh-Duy Le-Dinh</b>, Minh-Triet Tran, Hai-Dang Nguyen — <em>MAPR 2023</em>
                </div>
              </li>
            </ol>
          </section>

          <!-- Education & Careers -->
          <section id="careers" class="glass rounded-2xl shadow-sm p-6 hover-tilt scroll-mt-24">
            <h3 class="text-xl font-bold mb-3 text-slate-900 dark:text-slate-100">Education &amp; Careers</h3>
            <ul class="list-disc list-inside text-sm space-y-2 text-slate-700 dark:text-slate-200">
              <li>[2025 – Present] MBZUAI: PhD Student</li>
              <li>[2024 – 2025] University of Arkansas: Research Assistant</li>
              <li>[2023 – 2024] FPT Software — AI Center: Residency</li>
              <li>[2020 – 2023] Phenikaa MaaS: AI Team Lead / Backend Engineer</li>
              <li>[2019 – 2020] HCMUS — Computational Linguistic Center: Research Student</li>
              <li>[2018 – 2019] Piksal Studio: Backend Engineer</li>
              <li>[2017 – 2022] University of Science (HCMUS): Bachelor</li>
              <li>[2014 – 2017] Le Hong Phong High School for the Gifted</li>
            </ul>
          </section>

          <!-- Visitors (not in nav) -->
          <section id="visitors" class="glass rounded-2xl shadow-sm p-6 hover-tilt scroll-mt-24">
            <h3 class="text-xl font-bold mb-3 text-slate-900 dark:text-slate-100">Visitors</h3>

            <div class="flex flex-wrap items-center gap-3">
              <span class="text-sm text-slate-700 dark:text-slate-200">Total visits:</span>
              <img id="hitCounter" alt="Visitor counter badge" loading="lazy" class="h-6" />
            </div>

            <div class="mt-4 rounded-xl border border-slate-200/70 dark:border-slate-800/70 bg-white/60 dark:bg-slate-900/60 backdrop-blur p-3">
              <!-- Sized wrapper + mount point -->
              <div id="mmvWrap" class="w-full">
                <div id="mmvMount"></div>
              </div>
            </div>
          </section>
        </main>
      </div>
    </div>

    <!-- Footer -->
    <footer class="border-t border-slate-200 dark:border-slate-800 bg-white/70 dark:bg-slate-900/60 backdrop-blur">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4 text-center text-xs text-slate-600 dark:text-slate-400">
        © 2025 Le Dinh Anh Duy. All rights reserved.
      </div>
    </footer>

    <!-- AOS init -->
    <script src="https://cdn.jsdelivr.net/npm/aos@2.3.4/dist/aos.js"></script>
    <script>
      (function () {
        const reduce = matchMedia('(prefers-reduced-motion: reduce)').matches;
        if (!reduce && window.AOS) AOS.init({ duration: 650, easing: 'ease-out', once: true });
      })();
    </script>

    <!-- Faster loader -->
    <script>
      (function () {
        const loader = document.getElementById('loader');
        const reduce = matchMedia('(prefers-reduced-motion: reduce)').matches;
        function hide() {
          if (!loader) return;
          if (reduce) { loader.remove(); return; }
          loader.style.transition = 'opacity .35s ease, visibility 0s linear .35s';
          loader.style.opacity = '0'; loader.style.visibility = 'hidden';
          setTimeout(() => loader.remove(), 400);
        }
        if (document.readyState === 'interactive' || document.readyState === 'complete') hide();
        else document.addEventListener('DOMContentLoaded', hide, { once: true });
        setTimeout(hide, 1200);
      })();
    </script>

    <!-- Theme toggle (+ notify canvas for palette) -->
    <script>
      (function () {
        const btn = document.getElementById('toggleThemeBtn');
        const label = document.getElementById('themeLabel');
        function setPressed(isDark) {
          btn.setAttribute('aria-pressed', String(isDark));
          label.textContent = isDark ? 'Dark' : 'Light';
        }
        function toggleTheme() {
          const isDark = document.documentElement.classList.toggle('dark');
          localStorage.setItem('theme', isDark ? 'dark' : 'light');
          setPressed(isDark);
          window.dispatchEvent(new CustomEvent('themechange', { detail: { dark: isDark }}));
        }
        btn.addEventListener('click', toggleTheme);
        setPressed(document.documentElement.classList.contains('dark'));
      })();
    </script>

    <!-- Typewriter loop + cursor -->
    <script>
      (function () {
        const textEl = document.getElementById('typed-about-me-text');
        const text = "Hi, I'm Duy Le!";
        const reduce = matchMedia('(prefers-reduced-motion: reduce)').matches;
        if (reduce) { if (textEl) textEl.textContent = text; return; }
        function typeLoop() {
          if (!textEl) return;
          textEl.textContent = '';
          let i = 0;
          (function tick() {
            if (i < text.length) { textEl.textContent += text.charAt(i++); setTimeout(tick, 65); }
            else { setTimeout(typeLoop, 4000); }
          })();
        }
        setTimeout(typeLoop, 250);
      })();
    </script>

    <!-- Magnetic buttons -->
    <script>
      (function () {
        const reduce = matchMedia('(prefers-reduced-motion: reduce)').matches;
        if (reduce) return;
        const magnets = document.querySelectorAll('.magnet');
        const strength = 18;
        function move(e) {
          const r = this.getBoundingClientRect();
          const dx = (e.clientX - r.left - r.width/2) / (r.width/2);
          const dy = (e.clientY - r.top  - r.height/2) / (r.height/2);
          this.style.transform = `translate(${dx*strength}px, ${dy*strength}px)`;
        }
        function reset(){ this.style.transform = 'translate(0,0)'; }
        magnets.forEach(el => {
          el.style.transition = 'transform .18s ease';
          el.addEventListener('mousemove', move);
          el.addEventListener('mouseleave', reset);
        });
      })();
    </script>

    <!-- Scroll progress bar -->
    <script>
      (function () {
        const bar = document.getElementById('scrollProgress');
        function update() {
          const st = document.documentElement.scrollTop || document.body.scrollTop;
          const h = document.documentElement.scrollHeight - document.documentElement.clientHeight;
          bar.style.width = (h ? (st / h) * 100 : 0) + '%';
        }
        addEventListener('scroll', update, { passive: true });
        addEventListener('resize', update, { passive: true });
        update();
      })();
    </script>

    <!-- Canvas trailSpark (lighter, full-page) -->
    <script>
      (function () {
        const reduce = window.matchMedia('(prefers-reduced-motion: reduce)').matches;
        if (reduce) return;

        const canvas = document.getElementById('fxCanvas');
        const ctx = canvas.getContext('2d', { alpha: true });
        let dpr = Math.min(window.devicePixelRatio || 1, 1.5); // capped for perf
        let w = 0, h = 0;

        function resize() {
          w = innerWidth; h = innerHeight;
          dpr = Math.min(window.devicePixelRatio || 1, 1.5);
          canvas.width = Math.floor(w * dpr);
          canvas.height = Math.floor(h * dpr);
          canvas.style.width = w + 'px';
          canvas.style.height = h + 'px';
          ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
        }
        resize();
        addEventListener('resize', resize, { passive: true });

        // Particle pool (lightweight)
        const MAX = 160;
        const parts = [];
        let hueBase = document.documentElement.classList.contains('dark') ? 200 : 210;
        let visible = !document.hidden;

        document.addEventListener('visibilitychange', () => {
          visible = !document.hidden;
          if (visible) raf = requestAnimationFrame(loop);
        });

        addEventListener('themechange', (e) => { hueBase = e.detail.dark ? 200 : 210; });

        function addParticle(x, y, vx, vy, hue, size=1.2, ttl=55) {
          parts.push({ x, y, vx, vy, life: 0, ttl, size, hue });
          if (parts.length > MAX) parts.splice(0, parts.length - MAX);
        }

        // Coalesced pointer events
        let last = null;
        let colorShift = 0;
        let lastMoveTS = 0;

        function spawnTrailPoint(px, py) {
          const a = Math.random() * Math.PI * 2;
          const speed = 0.45 + Math.random() * 0.55;
          addParticle(
            px, py,
            Math.cos(a) * speed, Math.sin(a) * speed,
            hueBase + colorShift + (Math.random()*16 - 8),
            1.0 + Math.random()*0.8,
            42 + Math.random()*18
          );
        }

        function handlePointerMove(e) {
          const now = performance.now();
          if (now - lastMoveTS > 140) colorShift = (Math.random() * 100 - 50);
          lastMoveTS = now;

          const events = (typeof e.getCoalescedEvents === 'function') ? e.getCoalescedEvents() : [e];
          for (const ev of events) {
            const x = ev.clientX, y = ev.clientY;
            if (!last) { last = { x, y }; spawnTrailPoint(x, y); continue; }
            const dx = x - last.x, dy = y - last.y;
            const dist = Math.hypot(dx, dy);
            const step = 7; // every ~7px (light)
            const n = Math.max(1, Math.floor(dist / step));
            for (let i = 1; i <= n; i++) {
              const t = i / n;
              spawnTrailPoint(last.x + dx * t, last.y + dy * t);
            }
            last.x = x; last.y = y;
          }
        }
        addEventListener('pointermove', handlePointerMove, { passive: true });

        // Click/tap fireworks (lighter)
        addEventListener('pointerdown', (e) => {
          const x = e.clientX, y = e.clientY;
          const count = 12;
          const burstHue = hueBase + (Math.random()*80 - 40);
          for (let i = 0; i < count; i++) {
            const ang = (i / count) * Math.PI * 2;
            const spd = 2.0 + Math.random() * 1.2;
            addParticle(
              x, y,
              Math.cos(ang)*spd, Math.sin(ang)*spd,
              burstHue + (Math.random()*24 - 12),
              1.2 + Math.random()*1.2,
              36 + Math.random()*18
            );
          }
        }, { passive: true });

        // Draw
        const SHADOW_BLUR = 8;
        let raf;
        function loop() {
          if (!visible) return;
          ctx.clearRect(0, 0, w, h);
          ctx.globalCompositeOperation = 'lighter';
          ctx.shadowBlur = SHADOW_BLUR;

          for (let i = parts.length - 1; i >= 0; i--) {
            const p = parts[i];
            p.life++;
            if (p.life > p.ttl) { parts.splice(i, 1); continue; }

            p.vx *= 0.986;
            p.vy = p.vy * 0.986 + 0.018;
            p.x += p.vx; p.y += p.vy;

            const t = p.life / p.ttl;
            const alpha = (1 - t) * 0.65;
            const size = p.size * (1 - t * 0.5);

            ctx.beginPath();
            const col = `hsla(${p.hue}, 80%, 60%, ${alpha})`;
            ctx.fillStyle = col; ctx.shadowColor = col;
            ctx.arc(p.x, p.y, size, 0, Math.PI * 2);
            ctx.fill();
          }

          ctx.shadowBlur = 0;
          ctx.globalCompositeOperation = 'source-over';
          raf = requestAnimationFrame(loop);
        }
        raf = requestAnimationFrame(loop);
      })();
    </script>

    <!-- Visitors: hit counter + lazy-load MapMyVisitors (mounted inside card) -->
    <script>
      // Total visits badge
      (function () {
        const img = document.getElementById('hitCounter');
        if (!img) return;
        try {
          const u = encodeURIComponent(location.origin + location.pathname);
          img.src = `https://hits.seeyoufarm.com/api/count/incr/badge.svg?url=${u}&title=Visits`;
        } catch (e) { img.alt = 'Visits'; }
      })();

      // Lazy-load MapMyVisitors into the sized wrapper
      (function () {
        const MMV_SRC = "//mapmyvisitors.com/map.js?d=NVF7TjPnwJHipX-uOBqj8WNIauO9crtC0y_gf64huAY&cl=ffffff&w=a";
        let loaded = false;
        function loadMMV() {
          if (loaded) return; loaded = true;
          const mount = document.getElementById('mmvMount');
          if (!mount) return;
          const s = document.createElement('script');
          s.type = "text/javascript";
          s.id = "mapmyvisitors";
          s.src = MMV_SRC;
          mount.innerHTML = "";
          mount.appendChild(s); // render INSIDE the wrapper
        }
        const section = document.getElementById('visitors');
        if ('IntersectionObserver' in window && section) {
          const io = new IntersectionObserver((entries) => {
            if (entries.some(e => e.isIntersecting)) { loadMMV(); io.disconnect(); }
          }, { rootMargin: '200px 0px' });
          io.observe(section);
        } else if ('requestIdleCallback' in window) {
          requestIdleCallback(loadMMV, { timeout: 2000 });
        } else {
          setTimeout(loadMMV, 1500);
        }
      })();
    </script>
  </body>
</html>
